<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folder Browser</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-md mt-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Folder Browser</h1>
        <div class="text-sm text-gray-600">
            <!-- <p>Load subject list</p> -->
            <button id="reload-button" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="loadSubjectList()">Load Subjects</button>
        </div>

        <div class="mb-4">
            <label for="folder-select" class="block text-sm font-medium text-gray-700 mb-1">Subject List:</label>
            <div class="relative">
                <select id="folder-select" class="block w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5 appearance-none">
                    <option value="">Loading folders...</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
        </div>

        
        <div class="mb-4">
            <label for="file-select" class="block text-sm font-medium text-gray-700 mb-1">File List:</label>
            <div class="relative">
                <select id="file-select" class="block w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5 appearance-none">
                    <option value="">Loading folders...</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="text-sm text-gray-600">
            <button id="load-file-button" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="loadFile()">Load File</button>
        </div>

        <div id="selected-folder-info" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
            <h3 class="font-medium text-blue-800">Selected Folder:</h3>
            <p id="selected-folder-path" class="text-sm text-blue-700"></p>
        </div>
        
        <div id="error-message" class="mt-4 p-3 bg-red-50 rounded-lg hidden">
            <h3 class="font-medium text-red-800">Error:</h3>
            <p id="error-details" class="text-sm text-red-700"></p>
        </div>
    </div>

    <script>
        // DOM元素
        const folderSelect = document.getElementById('folder-select');
        const fileSelect = document.getElementById('file-select');
        const selectedFolderInfo = document.getElementById('selected-folder-info');
        const selectedFolderPath = document.getElementById('selected-folder-path');
        const errorMessage = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        
        // 加载文件夹列表
        async function loadSubjectList(path = '') {
            try {
                // 显示加载状态
                folderSelect.innerHTML = '<option value="">Loading folders...</option>';
                hideError();
                
                // 调用API获取文件夹列表
                const response = await fetch(`http://localhost:3000/api/list-subjects`);
                
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error || `Failed to load folders (${response.status})`);
                }
                
                const data = await response.json();

                // console.log(Object.keys(data).length);
                // 清空并添加默认选项
                folderSelect.innerHTML = '';
                // const defaultOption = document.createElement('option');
                // defaultOption.value = '';
                // defaultOption.textContent = '';
                // folderSelect.appendChild(defaultOption);
                
                for (const key in data) {
                    // console.log(key, data[key]);
                    const option = document.createElement('option');
                    option.value = data[key];
                    option.textContent = data[key];
                    folderSelect.appendChild(option);
                }

                
                // 如果没有文件夹
                if (Object.keys(data).length === 0) {
                    const noFolderOption = document.createElement('option');
                    noFolderOption.value = '';
                    noFolderOption.textContent = 'No folders found';
                    noFolderOption.disabled = true;
                    folderSelect.appendChild(noFolderOption);
                }
                
            } catch (error) {
                console.error('Error loading folders:', error);
                showError(error.message);
                folderSelect.innerHTML = '<option value="">Failed to load folders</option>';
            }
        }

        async function loadFileList(subject) {
            // 这里可以实现加载选中文件夹内文件的逻辑
            console.log(`Load files for subject: ${subject}`);
            try {
                // 显示加载状态
                fileSelect.innerHTML = '<option value="">Loading Files...</option>';
                hideError();
                
                // 调用API获取文件夹列表
                const response = await fetch(`http://localhost:3000/api/list-subjects-files?subject=${encodeURIComponent(subject)}`);
                
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error || `Failed to load folders (${response.status})`);
                }
                
                const data = await response.json();

                // console.log(Object.keys(data).length);
                console.log(data);
                // 清空并添加默认选项
                fileSelect.innerHTML = '';
                
                for (const key in data) {
                    // console.log(key, data[key]);
                    const option = document.createElement('option');
                    option.value = data[key];
                    option.textContent = data[key];
                    fileSelect.appendChild(option);
                }

                
                // 如果没有文件夹
                if (Object.keys(data).length === 0) {
                    const noFolderOption = document.createElement('option');
                    noFolderOption.value = '';
                    noFolderOption.textContent = 'No folders found';
                    noFolderOption.disabled = true;
                    fileSelect.appendChild(noFolderOption);
                }
                
            } catch (error) {
                console.error('Error loading folders:', error);
                showError(error.message);
                folderSelect.innerHTML = '<option value="">Failed to load folders</option>';
            }
        }
        
        async function loadFile() {
            // 这里可以实现加载选中文件夹内文件的逻辑
            subject = folderSelect.value;
            file = fileSelect.value;
            console.log(`Load file: ${subject}`);
            console.log(`Load file: ${file}`);
            const response = await fetch(`http://localhost:3000/api/load-subjects-files?subject=${encodeURIComponent(subject)}&file=${encodeURIComponent(file)}`);
                
                
            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.error || `Failed to load folders (${response.status})`);
            }
            
            const data = await response.json();
            console.log(data);
            showError(data);
        }

        // 显示错误信息
        function showError(message) {
            errorDetails.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        
        // 隐藏错误信息
        function hideError() {
            errorMessage.classList.add('hidden');
        }
        
        // 显示选中文件夹信息
        function showSelectedFolder(path) {
            if (path) {
                selectedFolderPath.textContent = path;
                selectedFolderInfo.classList.remove('hidden');
            } else {
                selectedFolderInfo.classList.add('hidden');
            }
        }


        // 监听下拉框变化
        folderSelect.addEventListener('change', (e) => {
            const selectedSubject = e.target.value;
            // showSelectedFolder(selectedSubject);
            loadFileList(selectedSubject);
            
            // 如果需要实现多级浏览，可以在这里递归加载子文件夹
            // loadSubjectList(selectedPath);
        });
        
        // 页面加载时加载根目录文件夹
        document.addEventListener('DOMContentLoaded', () => {
            loadSubjectList();
        });
    </script>
</body>
</html>