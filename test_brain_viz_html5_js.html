<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVF visualisation</title>
    <!-- Three.js library -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <!-- BrainBrowser library -->
    <script src="https://cdn.jsdelivr.net/npm/brainbrowser@2.3.0/lib/brainbrowser.min.js"></script>
    <!-- HDF5.js library (HDF5 data) -->
    <script src="./build/brainbrowser-2.5.2/brainbrowser.surface-viewer.min.js"></script>"></script>
    <script src="./build/brainbrowser-2.5.2/brainbrowser.volume-viewer.min.js"></script>"></script>
    <script src="https://cdn.jsdelivr.net/npm/h5wasm@0.8.6/dist/iife/h5wasm.min.js"></script>
    <!-- <script src="viz_brain_models.js"></script> -->
    <style>
        body { margin: 0; overflow: hidden; background: #0a0a1a; }
        
        #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; color: white; font-family: Arial; z-index: 100; display: flex; align-items: center; gap: 15px; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        button { background: #4CAF50; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        input[type="range"] { width: 200px; }
        #time-display { min-width: 60px; text-align: center; }
        .legend { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; color: white; font-family: Arial; z-index: 100; }
        .legend-item { margin: 5px 0; display: flex; align-items: center; }
        .color-block { width: 15px; height: 15px; margin-right: 8px; }
        #info-panel { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; color: white; font-family: Arial; z-index: 100; }
        #brainbrowser { position: absolute; top: 500px; left: 400px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; color: white; font-family: Arial; z-index: 5000; }
    </style>
</head>
<body>
    
    <div id="controls">
        <div class="control-group">
            <span>Time slider:</span>
            <input type="range" id="time-slider" min="0" max="300" value="0">
            <span id="time-display">0/300</span>
        </div>
        <button id="prev-time">Prev Time Frame</button>
        <button id="next-time">Next Time Frame</button>
        <button id="play-pause">Play/Pause</button>
        <button id="load-surf", onclick="loadBrainSurface()">Load Surface</button>
        <button id="load-pvfs", onclick="loadPVFHD5File()">Load PVFs</button>
        <input type="file" id="h5FilePicker">
        <button id="load-sing", onclick="readH5File()">Load Singularities</button>
        <button id="load-stln", onclick="loadBrainSurface()">Load Streamlines</button>
        <button id="reset-view">Reset View</button>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="color-block" style="background: #4c87af;"></div>
            <span>Phase Velocity Fields (vector fields)</span>
        </div>
        <div class="legend-item">
            <div class="color-block" style="background: linear-gradient(to right, red, blue);"></div>
            <span> Streamlines (Red: Start, Blue: End)</span>
        </div>
        <div class="legend-item">
            <div class="color-block" style="background: #fffb01;"></div>
            <span>PVF singularities</span>
        </div>
    </div>
    
    <div id="info-panel", class="info-panel">
        <h3>PVF Visualisation</h3>
        <p>Mouse Operations: Left Button Rotate | Scroll Zoom in/out | Right Button </p>
    </div>


    <div id="brainbrowser", class="viewer">Messages:</div>

    <script>


        document.getElementById('h5FilePicker').addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (file) {
            await h5wasm.ready;
            
            // 2. 加载文件
            const data = await file.arrayBuffer();
            const fileId = await h5wasm.FS_createDataFile('/', 'H5data.h5', data, true, false, false);
            const h5 = new h5wasm.File('/H5data.h5', 'r');
            
            // 3. 访问数据集
            const dataset = h5.get('pvf_data/validate_pvf/sub-BUTTLynden_EEG_ictal_acq-EyesClosed_run-1_velocityfields_20250618182906_h5py.h5');
            
            // 4. 读取数据
            const array = await dataset.value;
            
            console.log('数据形状:', dataset.shape);
            console.log('数据类型:', dataset.dtype);
            console.log('数据内容:', array);
            
            // 5. 清理资源
            h5.close();
            h5wasm.FS_unlink('pvf_data/validate_pvf/sub-BUTTLynden_EEG_ictal_acq-EyesClosed_run-1_velocityfields_20250618182906_h5py.h5');
        }
        });
        // --- 1. 配置和初始化 ---

        // 告诉 BrainBrowser 其核心文件的基础路径
        // 这对于加载 WebWorker 脚本等内部资源至关重要
        // BrainBrowser.config.set("base-path", "build/brainbrowser-2.5.2");

        // BrainBrowser.SurfaceViewer.start("brainbrowser", function(viewer) {
        //     //Add an event listener.
        //     viewer.addEventListener("displaymodel", function() {
        //     console.log("We have a model!");
        //     });

        //     // Start rendering the scene.
        //     viewer.render();

        //     // Load a model into the scene.
        //     viewer.loadModelFromURL("fs_data/BUTTLynden/surf/lh.pial.T1.obj");
        //     viewer.loadModelFromURL("fs_data/BUTTLynden/surf/rh.pial.T1.obj");

        //     // Hook viewer behaviour into UI.
        //     $("#wireframe").change(function(e) {
        //     viewer.setWireframe($(this).is(":checked"));
        //     });
        // });
        // function loadPVFFromFile() {
        //     alert("Loading brain surface...");
        // }
        
        function loadPVFHD5File(url) {
            url="pvf_data/validate_pvf/sub-BUTTLynden_EEG_ictal_acq-EyesClosed_run-1_velocityfields_20250618182906_h5py.h5";
            return h5wasm.ready.then(() => {
                return h5wasm.open(url, 'r').then(file => {
                    const data = {};
                    // 假设文件中有这些数据集
                    const datasets = ['mask', 'vx', 'vy', 'vz'];
                    datasets.forEach(name => {
                        if (file.exists(name)) {
                            const dataset = file.get(name);
                            data[name] = dataset.toArray();
                        } else {
                            console.warn(`Dataset ${name} does not exist in the file.`);
                        }
                    });
                    file.close();
                    return data;
                });
            });
        }
    </script>
</body>
</html>